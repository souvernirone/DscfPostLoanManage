@using System.Web.Optimization
@{
    ViewBag.Title = "逾期客户";
}


<div class="g-mn1c tb">
    <ul class="m-tnav">
        <li class="active">
            <a data-href="#chang">车贷长期</a>
        </li>
        <li>
            <a id="tabShort" data-href="#duan">车贷短期</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="table-responsive tab-pane active" id="chang">
            <div class="search-long-condition">
                <input type="hidden" name="IsLongLoan" value="true" />
            </div>
            <table class="table table-bordered noborder">
                <thead>
                    <tr>
                        <th>操作人</th>
                        <th>地区</th>
                        <th>姓名</th>
                        <th>产品类型</th>
                        <th>逾期次数</th>
                        <th>首逾日期</th>
                        <th>债权状态</th>
                        <th>累计逾期本金</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="longContainer"></tbody>
            </table>
            <!--分页局部视图-->
            <div>@Html.Partial("_PartialPager")</div>
        </div>

        <div class="table-responsive tab-pane " id="duan">
            <div class="search-short-condition">
                <input type="hidden" name="IsLongLoan" value="false" />
            </div>
            <table class="table table-bordered noborder">
                <thead>
                    <tr>
                        <th>操作人</th>
                        <th>地区</th>
                        <th>姓名</th>
                        <th>产品类型</th>
                        <th>逾期次数</th>
                        <th>首逾日期</th>
                        <th>债权状态</th>
                        <th>累计逾期本金</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="shortContainer"></tbody>
            </table>

            <!--分页HTML开始-->
            <div id="pagerOther" style="float:left"></div>
            <div style="float:left;margin-left:20px" id="selectCount">
                页面显示
                <select id="selelct_OtherPageCount" style="font-size: 16px;height:38px;width:55px;" class="select">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="5">5</option>
                    <option selected="selected" value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
                条
            </div>
            <!--分页HTML结束-->
        </div>

    </div>
</div>
<div id="assign" class="f-hide alert">
    <form id="remindForm">
        <p>
            <label>地区：</label>
            <span id="signCity"></span>
        </p>
        <p>
            <label>姓名：</label>
            <span id="userName"></span>
        </p>
        <p>
            <label>产品类型：</label>
            <span id="productName"></span>
        </p>
        <p>
            <label>首逾日期：</label>
            <span id="firstOverdueTime"></span>
        </p>

        <p>
            <label>催收人：</label>
            <span class="selectimg">
                <select id="deptOptId" name="deptOptId" class="form-control select">
                    @{System.Text.StringBuilder u = new System.Text.StringBuilder("");}
                    @{foreach (var a in @ViewBag.CollectorRole)
                    {
                        u.AppendFormat("<option value=" + a.Id + ">" + a.Name + "</option>");
                    }}
                    @Html.Raw(u);
                </select>
                <span></span>
            </span>
        </p>
    </form>
</div>
@section scripts
{
    @Scripts.Render("~/bundles/dialog")
    @Scripts.Render("~/bundles/dataPagerJs")
    @Scripts.Render("~/bundles/dataFormat")
    <script type="text/javascript">

        $(function () {
            getPageLongCarOverdueList();
            getPageShortCarOverdueList();
        });

        function getPageLongCarOverdueList() {
            var page = new Page();
            page.Dom = $(".search-long-condition");
            page.Url = "/OverdueCustomer/GetPageCarOverdueList";
            page.Container = $("#longContainer");
            page.CallBack = function (data) {
                $("#longContainer").empty();
                $.each(data, function (index, item) {
                    item.FirstOverdueTime = $.format.timestamp(item.FirstOverdueTime, "yyyy年MM月dd日");
                    $("#templeteLongLoan").tmpl(item).appendTo($("#longContainer"));
                });
            };
            page.GetPageData();
        }

        function getPageShortCarOverdueList() {
            var page = new OtherPage();
            page.Dom = $(".search-short-condition");
            page.Url = "/OverdueCustomer/GetPageCarOverdueList";
            page.Container = $("#shortContainer");
            page.CallBack = function (data) {
                $("#shortContainer").empty();
                $.each(data, function (index, item) {
                    item.FirstOverdueTime = $.format.timestamp(item.FirstOverdueTime, "yyyy年MM月dd日");
                    item.ShowExtBtn = item.IsCanExtension == true && item.ExtensionApplyCount == 0 && item.ReconsiderationStatusId == 3004;
                    item.ShowReconBtn = item.IsCanExtension == true && item.ExtensionApplyCount == 0 && (item.ReconsiderationStatusId == null || item.ReconsiderationStatusId == 3002);
                    $("#templeteShortLoan").tmpl(item).appendTo($("#shortContainer"));
                });
            };
            page.GetPageData();
        }
        function assign(obj) {
            $("#signCity").text($(obj).parent().parent().children().eq(1).text());
            $("#userName").text($(obj).parent().parent().children().eq(2).text());
            $("#productName").text($(obj).parent().parent().children().eq(3).text());
            $("#firstOverdueTime").text($(obj).parent().parent().children().eq(5).text());
            $("#deptOptId option:contains('" + $(obj).parent().parent().children().eq(0).text() + "')")[0].selected = true;
            new Alert().AlertInfo({
                content: "#assign",
                width: "450",
                height: "360",
                callBack: function () {
                    var parms = {};
                    parms.orderId = $(obj).parent().parent().attr("data-orderid");
                    parms.deptOptId = $("#deptOptId").val();
                    parms.orderType = 2;
                    $.ajax({
                        url: "/OverdueCustomer/UpdateLoanProductOrderReminder",
                        method: "post",
                        async: true,
                        dataType: "json",
                        data: parms,
                        success: function (result) {
                            if (result.ReturnType == false)
                                new Alert().AlertInfo({
                                    content: result.ReturnMsg,
                                    iClass: 'error'
                                });
                            else {
                                $(obj).parent().parent().children().eq(0).text($("#deptOptId option:selected").text())
                            }
                        }
                    });
                }
            });
        }
    </script>

    <script id="templeteLongLoan" type="text/x-jquery-tmpl">
        <tr id="row-${OrderId}" data-orderid="${OrderId}">
            <td>${CollectorName}</td>
            <td>${SignCity}</td>
            <td>${UserName}</td>
            <td>${ProductName}</td>
            <td>${OverdueCount}</td>
            <td>${FirstOverdueTime}</td>
            <td>${CarLoanStatusName}</td>
            <td>${OverduePrincipalSum}</td>
            <td>${CollectStatusName}</td>
            <td>
                <a class="u-b-one s-b-blue " target="_self" href="/OverdueCustomer/CarOverdueDetail?orderId=${OrderId}&css=1056">详</a>
                @if (ViewBag.IsAssign == true)
                {
                    <a class="u-b-one s-b-orage "  onclick="assign(this)">派</a>
                }
            </td>
        </tr>
    </script>


    <script id="templeteShortLoan" type="text/x-jquery-tmpl">
        <tr id="row-${OrderId}" data-orderid=" ${OrderId}" data-collector="${CollectorId}">
            <td>${CollectorName}</td>
            <td>${SignCity}</td>
            <td>${UserName}</td>
            <td>${ProductName}</td>
            <td>${OverdueCount}</td>
            <td>${FirstOverdueTime}</td>
            <td>${CarLoanStatusName}</td>
            <td>${OverduePrincipalSum}</td>
            <td>${CollectStatusName}</td>
            <td>
                <a class="u-b-one s-b-blue " target="_self" href="/OverdueCustomer/CarOverdueDetail?orderId=${OrderId}&css=1056">详</a>

                {{if ShowExtBtn}}
                <a class="u-b-one s-b-blue1 " target="_blank" href="/RepayRemind/CarRemindExtensionDetail?orderId=${OrderId}&repayId=${RepayId}&css=1056">展</a>
                {{else}}
                <a class="u-b-one s-b-gray " href="#">展</a>
                {{/if}}

                {{if ShowReconBtn}}
                <a class="u-b-one s-b-blue1 " target="_blank" href="/Reconsider/Detail?orderId=${OrderId}&css=1056">议</a>
                {{else}}
                <a class="u-b-one s-b-gray " href="#">议</a>
                {{/if}}

             
                @if (ViewBag.IsAssign == true)
                {
                    <a class="u-b-one s-b-orage "  onclick="assign(this)">派</a>
                }
            </td>
        </tr>
    </script>
}

