@using System.Web.Optimization
@using Dscf.PostLoanGlobal
@{
    ViewBag.Title = "划扣审批";
}

<div class="g-mn1c tb">

    <table class="table table-bordered">
        <thead>
            <tr>
                <td class="city"><input id="allCh" type="checkbox" style="display: block;"></td>
                <th>操作人</th>
                <th>地区</th>
                <th>姓名</th>
                <th>产品类型</th>
                <th>签约日期</th>
                <th>逾期次数</th>
                <th>首逾日期</th>
                <th>债权状态</th>
                <th>累计逾期本金</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="container"></tbody>
    </table>

    <!--分页局部视图-->
    <div>@Html.Partial("_PartialPager")</div>
    <div id="addReason" class="f-hide alert">
        <form id="reasonForm">
            <p class="height">
                <label>拒绝原因：</label>
                <textarea id="reasonContent" name="reasonContent" class="form-control  height"></textarea>
            </p>
        </form>
    </div>
</div>
<div style="margin-left: 80.8%">
    <button class="u-b-base u-b-exprot s-b-blue u-b-spild1" onclick="pass()">通过</button>
    <button class="u-b-base u-b-exprot s-b-red u-b-spild1" onclick="reject()">驳回</button>
</div>
@section scripts
{
    @Scripts.Render("~/bundles/dataPagerJs")
    @Scripts.Render("~/bundles/dataFormat")
    <script type="text/javascript">

        $(function () {
            getPageOverdueList();
            $("#allCh").click(function () {
                $("input[name='Checked'] ").prop("checked", this.checked);
            });
            $("input[name='Checked']").click(function () {
                if(!this.checked)
                    $("#allCh").prop("checked", this.checked);
            })
        });

        function getPageOverdueList() {
            var page = new Page();
            page.Url = "/Approval/GetDeductApprovalList";
            page.Container = $("#container");
            page.CallBack = function (data) {
                $("#container").empty();
                $.each(data, function (index, item) {
                    item.FirstOverdueTime = $.format.timestamp(item.FirstOverdueTime, "yyyy年MM月dd日");
                    item.SignDate = $.format.timestamp(item.SignDate, "yyyy年MM月dd日");
                    $("#templete").tmpl(item).appendTo($("#container"));
                });
            };
            page.GetPageData();
        }

        function redirect(orderId, orderType) {
            if (orderType == "1") {
                window.open("/Approval/CreditClaimsDetail?orderId=" + orderId+"&css=1055");
            }
            else {
                window.open("/Approval/CarClaimsDetail?orderId=" + orderId +"&css=1055");
            }
        }
        function pass() {
            new Alert().AlertInfo({
                content: "确定通过吗？",
                iClass: 'yes',
                callBack: function () {
                    var params = {};
                    var chk_value = [];
                    $('input[name="Checked"]:checked').each(function () {
                        chk_value.push($(this).val() + "," + $(this).parent().parent().attr("data-ordertype"));
                    });

                    params.idAndTypes = chk_value;
                    params.status = @DeductPayUtil.OrderCollectApproved
                        $.ajax({
                            url: "/Approval/UpdateApplyStatusBatch",
                            method: "post",
                            async: true,
                            dataType: "json",
                            data: params,
                            success: function (result) {
                                if (!result.ReturnType) {
                                    new Alert().AlertInfo({
                                        content: result.ReturnMsg,
                                        iClass: result.ReturnType ? 'yes' : 'error'
                                    });
                                }
                                else { getPageOverdueList(); }
                            }
                        });
                }
            })
        }
        function reject() {
            $("#tile").empty();
            new Alert().AlertInfo({
                content: "#addReason",
                width: "450",
                height: "280",
                callBack: function () {
                    if ($("#reasonContent").val() == "") {
                        new Alert().AlertInfo({
                            content: "请输入拒绝原因！",
                            iClass: 'error'
                        });
                        return;
                    }
                    var params = {};
                    var chk_value = [];
                    $('input[name="Checked"]:checked').each(function () {
                        chk_value.push($(this).val() + "," + $(this).parent().parent().attr("data-ordertype"));
                    });

                    params.idAndTypes = chk_value;
                    params.status = @DeductPayUtil.OrderCollectNotApproved
                    params.reason = $("#reasonContent").val();
                    $.ajax({
                        url: "/Approval/UpdateApplyStatusBatch",
                        method: "post",
                        async: true,
                        dataType: "json",
                        data: params,
                        success: function (result) {
                            if (result.ReturnType == false) {
                                new Alert().AlertInfo({
                                    content: result.ReturnMsg,
                                    iClass: result.ReturnType ? 'yes' : 'error'
                                });
                            }
                            else {
                                getPageOverdueList();
                            }
                        }
                    });
                }
            });
        }

    </script>
    <script id="templete" type="text/x-jquery-tmpl">
        <tr id="row-${OrderId}" data-orderid="${OrderId}" data-ordertype="${OrderType}">
            <td class="city"><input name="Checked" value="${OrderId}" type="checkbox" style="display: block;" ></td>
            <td>${CollectorName}</td>
            <td>${SignCity}</td>
            <td>${UserName}</td>
            <td>${ProductName}</td>
            <td>${SignDate}</td>
            <td>${OverdueCount}</td>
            <td>${FirstOverdueTime}</td>
            <td>${CreditStatusName}</td>
            <td>${OverduePrincipalSum}</td>
            <td>
                <a class="u-b-one s-b-blue" onclick="redirect('${OrderId}', '${OrderType}')">详</a>
            </td>
        </tr>

    </script>

}

